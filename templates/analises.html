{% extends 'base.html' %}
{% load static %}

{% block title %}- Análises{% endblock %}

{% block page_header %}Análises{% endblock %}


{% block content %}
	<div class="col-12 text-center mb-3">
		<h4>Recomendável ver em dispositivos com telas maiores</h4>
	</div>
	
	<div class="col-12 col-md-12 my-2">
		<div class="card">
		  	<div class="card-header bg-cinza-2">
		    	Vitórias por personagem
		  	</div>
		  	<div class="card-body col-12">
				<img src="{% static imagens.vitorias_por_personagem %}" width="100%">
			</div>
		</div>
	</div>
	
	<div class="col-12 col-md-12 my-2">
		<div class="card">
		  	<div class="card-header bg-cinza-2">
		    	Quantidade/Resultado de desafios por posição
		  	</div>
		  	<div class="card-body col-12">
				<img src="{% static imagens.result_por_posicao %}" width="100%">
			</div>
		</div>
	</div>	
	
	<div class="col-12 col-md-12 my-2">
		<div class="card">
		  	<div class="card-header bg-cinza-2">
		    	Resultado acumulado de desafios entre jogadores
		  	</div>
		  	<div class="card-body col-12" id="cardGrafAcumJogadores">
		  		<div class="col-12 text-center mb-0">
		  			<h4><span id="mes"></span> / <span id="ano"></span></h4>
		  		</div>
		  		<div class="col-12 text-center mb-3">
		  			<input class="btn btn-lg btn-dark mt-4" id="ant_acumulado" type="button" value="Anterior">
		  			<input class="btn btn-lg btn-dark mt-4" id="prox_acumulado" type="button" value="Próximo">
	  			</div>
	  			
	  			<div id="grafAcumJogadores"></div>
			</div>
		</div>
	</div>
	
	<div class="col-12 col-md-12 my-2">
		<div class="card">
		  	<div class="card-header bg-cinza-2">
		    	Vitórias/derrotas por diferença de posições
		  	</div>
		  	<div class="card-body col-12">
				<img src="{% static imagens.result_dif_posicao %}" width="48%">
				<img src="{% static imagens.result_dif_posicao_perc %}" width="48%">
			</div>
		</div>
	</div>
	
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js"></script>

<script type="text/javascript">
var dataAtual = new Date();
var mes = dataAtual.getMonth() + 1;
var ano = dataAtual.getYear() + 1900;

var max_mes = mes;
var min_mes = 4;

var max_ano = ano;
var min_ano = 2019;

function alterar_mes_ano() {
	$('#mes').html(mes);
	$('#ano').html(ano);
}

$(document).ready(function(){
	alterar_mes_ano();
	
	$('#prox_acumulado').click(function() {
		if ((ano == max_ano && mes < max_mes) || (ano < max_ano)) {
			mes += 1;
			if (mes == 13) {
				ano += 1;
				mes = 1;
			}
			alterar_mes_ano();
			plotGraficoAcumuladoEntreJogadores();
		}
	});
	
	$('#ant_acumulado').click(function() {
		if ((ano == min_ano && mes > min_mes) || (ano > min_ano)) {
			mes -= 1;
			if (mes == 0) {
				ano -= 1;
				mes = 12;
			}
			alterar_mes_ano();
			plotGraficoAcumuladoEntreJogadores();
		}
	});
	
	plotGraficoAcumuladoEntreJogadores();
});

function plotGraficoAcumuladoEntreJogadores() {
	$('#cardGrafAcumJogadores').block({ 
        message: '<h4>...</h4>', 
        css: { border: '3px solid #000' } 
    });
    
	ajax("{% url 'analise_result_acum_jogadores' %}", 
		'GET', 
		{ano: ano, mes: mes}, 
		function(resultado) {
			var data = [
			  {
				z: resultado.resultado_desafios,
				x: resultado.jogador_enfrentado,
				y: resultado.jogador,
				hovertemplate: 'Jogador: <b>%{y}</b>' +
                        '<br>Oponente: <b>%{x}</b>' +
                        '<br>Resultado: <b>%{z:.2f}</b>',
			  	hoverinfo: 'text',
			  	name: '',
				type: 'heatmap',
				reversescale: true
			  }
			];
			
			var layout = {
			  height: 30 * resultado.jogador.length,
			  xaxis: {
			  	title: 'Oponente enfrentado'
			  }
			};
			
			Plotly.newPlot('grafAcumJogadores', data, layout);
			$('#cardGrafAcumJogadores').unblock(); 
        }
    );
}
</script>
{% endblock %}